#include <stdio.h>
#include <stdlib.h>
#include <sys/stat.h>
#include <stdbool.h>


bool file_exists (char *filename) {
  struct stat   buffer;
  return (stat (filename, &buffer) == 0);
}

int convert_CP1251_to_UTF8(FILE *stream, FILE *stream_save)
{
    unsigned char char1251;
    fseek(stream, 0L, SEEK_END);
    long sz = ftell(stream);
    long offset = 0;
    unsigned char write_[1] = {0};
    int idxs[256] =                 {0,1,2,3,4,5,6,7,8,9, 10,11,12,13,14,15,16,17,18,19, 20,21,22,23,24,25,26,27,28,29, 30,31,32,33,34,35,36,37,38,39, 40,41,42,43,44,45,46,47,48,49, 50,51,52,53,54,55,56,57,58,59, 60,61,62,63,64,65,66,67,68,69, 70,71,72,73,74,75,76,77,78,79, 80,81,82,83,84,85,86,87,88,89, 90,91,92,93,94,95,96,97,98,99, 100,101,102,103,104,105,106,107,108,109, 110,111,112,113,114,115,116,117,118,119, 120,121,122,123,124,125,126,127, 128,    130,    132,        135,    137,        140,        143,        146,        149,        152,        155,    157,        160,    162,    164,    166,    168,    170,        173,        176,        179,        182,        185,        188,        191,    193,        196,    198,        201,    203,    205,    207,    209,    211,    213,    215,    217,    219,    221,    223,    225,    227,    229,    231,    233,    235,    237,    239,    241,    243,    245,    247,    249,    251,    253,    255,    257,    259,        262,    264,    266,    268,    270,    272,    274,    276,    278,    280,    282,    284,    286,    288,    290,    292,    294,    296,    298,    300,    302,    304,    306,    308,    310,    312,    314,    316,    318,    320,    322,    324,    326,    328,    330,    332,    334,    336,    338,    340,    342,    344,    346,    348,    350,    352,    354,    356,    358,    360,    362,    364,    366,    368,    370,    372,    374,    376,    378,    380,    382,    384,    386,    388,    390,    392,    394,    396,    398,    400    };
    int lens[256] =                 {1,1,1,1,1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,   1,  1,  1,  1,  1,  1,  1,  1,   2,      2,      3,          2,      3,          3,          3,          3,          3,          3,          2,      3,          2,      2,      2,      2,      2,      3,          3,          3,          3,          3,          3,          3,          2,      3,          2,      3,          2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      3,          2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2,      2      };
    unsigned char conv_masks[402] = {0,1,2,3,4,5,6,7,8,9, 10,11,12,13,14,15,16,17,18,19, 20,21,22,23,24,25,26,27,28,29, 30,31,32,33,34,35,36,37,38,39, 40,41,42,43,44,45,46,47,48,49, 50,51,52,53,54,55,56,57,58,59, 60,61,62,63,64,65,66,67,68,69, 70,71,72,73,74,75,76,77,78,79, 80,81,82,83,84,85,86,87,88,89, 90,91,92,93,94,95,96,97,98,99, 100,101,102,103,104,105,106,107,108,109, 110,111,112,113,114,115,116,117,118,119, 120,121,122,123,124,125,126,127, 208,130,208,131,226,128,154,209,147,226,128,158,226,128,166,226,128,160,226,128,161,226,130,172,226,128,176,208,137,226,128,185,208,138,208,140,208,139,208,143,209,146,226,128,152,226,128,153,226,128,156,226,128,157,226,128,162,226,128,147,226,128,148,194,152,226,132,162,209,153,226,128,186,209,154,209,156,209,155,209,159,194,160,208,142,209,158,208,139,194,164,210,144,194,166,194,167,208,129,194,169,208,132,194,171,194,172,194,173,194,174,208,135,194,176,194,177,208,134,209,150,210,145,194,181,194,182,194,183,209,145,226,132,150,209,148,194,187,209,152,208,133,209,149,209,151,208,144,208,145,208,146,208,147,208,148,208,149,208,150,208,151,208,152,208,153,208,154,208,155,208,156,208,157,208,158,208,159,208,160,208,161,208,162,208,163,208,164,208,165,208,166,208,167,208,168,208,169,208,170,208,171,208,172,208,173,208,174,208,175,208,176,208,177,208,178,208,179,208,180,208,181,208,182,208,183,208,184,208,185,208,186,208,187,208,188,208,189,208,190,208,191,209,128,209,129,209,130,209,131,209,132,209,133,209,134,209,135,209,136,209,137,209,138,209,139,209,140,209,141,209,142,209,143};

    do
    {
        fseek(stream, offset, SEEK_SET);
        fread(&char1251, sizeof(char1251), 1, stream);
        int idx = idxs[char1251];
        int len = lens[char1251];

        for(int i = idx; i < idx+len; ++i)
        {
            write_[0] = conv_masks[i];
            fwrite(write_, 1 , sizeof(write_), stream_save);
        }
        ++offset;
    } while (offset != sz); // пока не конец файла

    return 0;
}


int convert_KOI8_R_to_UTF8(FILE *stream, FILE *stream_save)
{
    unsigned char charKoi8;
    fseek(stream, 0L, SEEK_END);
    long sz = ftell(stream);
    long offset = 0;
    unsigned char write_[1] = {0};

    int idxs[256] = {0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,131,134,137,140,143,146,149,152,155,158,161,164,167,170,173,176,179,182,185,188,191,194,197,200,203,206,208,211,213,215,217,219,222,225,228,230,233,236,239,242,245,248,251,254,257,260,263,266,269,272,275,277,280,283,286,289,292,295,298,301,304,307,310,312,314,316,318,320,322,324,326,328,330,332,334,336,338,340,342,344,346,348,350,352,354,356,358,360,362,364,366,368,370,372,374,376,378,380,382,384,386,388,390,392,394,396,398,400,402,404,406,408,410,412,414,416,418,420,422,424,426,428,430,432,434,436,438};
    int lens[256] = {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,3,2,2,2,2,3,3,3,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2};
    unsigned int conv_masks[430] = {0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,226,148,128,226,148,130,226,148,140,226,148,144,226,148,148,226,148,152,226,148,156,226,148,164,226,148,172,226,148,180,226,148,188,226,150,128,226,150,132,226,150,136,226,150,140,226,150,144,226,150,144,226,150,146,226,150,147,226,140,160,226,150,160,226,136,153,226,136,154,226,137,136,226,137,164,226,137,165,194,160,226,140,161,194,176,194,178,194,183,195,183,226,149,144,226,149,145,226,149,146,209,145,226,149,147,226,149,148,226,149,149,226,149,150,226,149,151,226,149,152,226,149,153,226,149,154,226,149,155,226,149,156,226,149,157,226,149,158,226,149,159,226,149,160,226,149,161,208,129,226,149,162,226,149,163,226,149,164,226,149,165,226,149,166,226,149,167,226,149,168,226,149,169,226,149,170,226,149,171,226,149,172,194,169,209,142,208,176,208,177,209,134,208,180,208,181,209,132,208,179,209,133,208,184,208,185,208,186,208,187,208,188,208,189,208,190,208,191,209,143,209,128,209,129,209,130,209,131,208,182,208,178,209,140,209,139,208,183,209,136,209,141,209,137,209,135,209,138,208,174,208,144,208,145,208,166,208,148,208,149,208,164,208,147,208,165,208,152,208,153,208,154,208,155,208,156,208,157,208,158,208,159,208,175,208,160,208,161,208,162,208,163,208,150,208,146,208,172,208,171,208,151,208,168,208,173,208,169,208,167,208,170};
    int pos = 0;
    do
    {
        fseek(stream, offset, SEEK_SET);
        fread(&charKoi8, sizeof(charKoi8), 1, stream);
        int idx = idxs[charKoi8];
        int len = lens[charKoi8];

        for(int i = idx; i < idx+len; ++i)
        {
            write_[0] = conv_masks[i];
            fwrite(write_, 1 , sizeof(write_), stream_save);
            pos++;
        }
        ++offset;
    } while (offset != sz); // пока не конец файла

    return 0;
}

int convert_ISO_8859_5_to_UTF8(FILE *stream, FILE *stream_save)
{
    unsigned char charIso_8859_5;
    fseek(stream, 0L, SEEK_END);
    long sz = ftell(stream);
    long offset = 0;
    unsigned char write_[1] = {0};

    int idxs[256] = {0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,130,132,134,136,138,140,142,144,146,148,150,152,154,156,158,160,162,164,166,168,170,172,174,176,178,180,182,184,186,188,190,192,194,196,198,200,202,204,206,208,210,212,214,216,218,220,222,224,226,228,230,232,234,236,238,240,242,244,246,248,250,252,254,256,258,260,262,264,266,268,270,272,274,276,278,280,282,284,286,288,290,292,294,296,298,300,302,304,306,308,310,312,314,316,318,320,322,324,326,328,330,332,334,336,338,340,342,344,346,348,350,352,355,357,359,361,363,365,367,369,371,373,375,377,379,381,383};
    int lens[256] = {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2};
    unsigned char conv_masks[402] = {0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,194,128,194,129,194,130,194,131,194,132,194,133,194,134,194,135,194,136,194,137,194,138,194,139,194,140,194,141,194,142,194,143,194,144,194,145,194,146,194,147,194,148,194,149,194,150,194,151,194,152,194,153,194,154,194,155,194,156,194,157,194,158,194,159,194,160,208,129,208,130,208,131,208,132,208,133,208,134,208,135,208,136,208,137,208,138,208,139,208,140,194,173,208,142,208,143,208,144,208,145,208,146,208,147,208,148,208,149,208,150,208,151,208,152,208,153,208,154,208,155,208,156,208,157,208,158,208,159,208,160,208,161,208,162,208,163,208,164,208,165,208,166,208,167,208,168,208,169,208,170,208,171,208,172,208,173,208,174,208,175,208,176,208,177,208,178,208,179,208,180,208,181,208,182,208,183,208,184,208,185,208,186,208,187,208,188,208,189,208,190,208,191,209,128,209,129,209,130,209,131,209,132,209,133,209,134,209,135,209,136,209,137,209,138,209,139,209,140,209,141,209,142,209,143,226,132,150,209,145,209,146,209,147,209,148,209,149,209,150,209,151,209,152,209,153,209,154,209,155,209,156,194,167,209,158,209,159};

    do
    {
        fseek(stream, offset, SEEK_SET);
        fread(&charIso_8859_5, sizeof(charIso_8859_5), 1, stream);
        int idx = idxs[charIso_8859_5];
        int len = lens[charIso_8859_5];

        for(int i = idx; i < idx+len; ++i)
        {
            write_[0] = conv_masks[i];
            fwrite(write_, 1 , sizeof(write_), stream_save);
        }
        ++offset;
    } while (offset != sz); // пока не конец файла

    return 0;
}

int main(int argc, char **argv)
{
    if(argc == 4)
    {
        for(int i = 0; i<argc; ++i)
        {
            printf("%s \n", argv[i]);
        }

        char file_name[FILENAME_MAX] = "cp1251.txt";
        strcpy (file_name, argv[1]);
        char file_name_save[FILENAME_MAX] = "t.txt";
        strcpy (file_name_save, argv[2]);
        char encode_type[FILENAME_MAX] = "";
        strcpy (encode_type, argv[3]);

        if(file_exists(file_name))
        {
            FILE *file;
            FILE *file_save;

            file = fopen(file_name, "rb+");
            file_save = fopen(file_name_save, "wb+");
            printf(encode_type);
            if(strcmp(encode_type, "cp1251")==0)
            {
                convert_CP1251_to_UTF8(file, file_save);
            }
            else if (strcmp(encode_type, "koi8_r")==0)
            {
                convert_KOI8_R_to_UTF8(file, file_save);

            }
            else if (strcmp(encode_type, "iso_8859_5")==0)
            {
                convert_ISO_8859_5_to_UTF8(file, file_save);
            }

            fclose(file);
            fclose(file_save);
            printf("%s\n", "Конвертация завершина.");
        }
        else
        {
            printf("%s\n", "Файл не найден.");

        }
        printf("Программа завершена.\n");
    }
    else
    {
        printf("Аргументы не в соответствуют. Пример main.c cp1251.txt utf-8.txt cp1251\n");
    }
    return 0;
}
