#include <stdio.h>
#include <stdlib.h>
#include <sys/stat.h>
#include <stdbool.h>


bool file_exists (char *filename) {
  struct stat   buffer;
  return (stat (filename, &buffer) == 0);
}

int convert_CP1251_to_UTF8(FILE *stream, FILE *stream_save)
{
    unsigned char char1251;
    fseek(stream, 0L, SEEK_END);
    long sz = ftell(stream);
    long offset = 0;
    unsigned char write_[1] = {0};
    int idxs[256] = {0,1,2,3,4,5,6,7,8,9, 10,11,12,13,14,15,16,17,18,19, 20,21,22,23,24,25,26,27,28,29, 30,31,32,33,34,35,36,37,38,39, 40,41,42,43,44,45,46,47,48,49, 50,51,52,53,54,55,56,57,58,59, 60,61,62,63,64,65,66,67,68,69, 70,71,72,73,74,75,76,77,78,79, 80,81,82,83,84,85,86,87,88,89, 90,91,92,93,94,95,96,97,98,99, 100,101,102,103,104,105,106,107,108,109, 110,111,112,113,114,115,116,117,118,119, 120,121,122,123,124,125,126,127, 128, 130, 132, 135, 137, 140, 143, 146, 149, 152, 155, 157, 160, 162, 164, 166, 168, 170, 173, 176, 179, 182, 185, 188, 191, 193, 196, 198, 201, 203, 205, 207, 209, 211, 213, 215, 217, 219, 221, 223, 225, 227, 229, 231, 233, 235, 237, 239, 241, 243, 245, 247, 249, 251, 253, 255, 257, 259, 262, 264, 266, 268, 270, 272, 274, 276, 278, 280, 282, 284, 286, 288, 290, 292, 294, 296, 298, 300, 302, 304, 306, 308, 310, 312, 314, 316, 318, 320, 322, 324, 326, 328, 330, 332, 334, 336, 338, 340, 342, 344, 346, 348, 350, 352, 354, 356, 358, 360, 362, 364, 366, 368, 370, 372, 374, 376, 378, 380, 382, 384, 386, 388, 390, 392, 394, 396, 398, 400 };
    int lens[256] = {1,1,1,1,1,1,1,1,1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  1, 1, 1, 1, 1, 1, 1, 1, 1, 1,  1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1, 1, 1, 1, 1, 1, 1, 1, 1, 1,1,1,1,1,1,1,1,1,2, 2, 3, 2, 3, 3, 3, 3, 3, 3,2,3,2,2,2,2,2,3,3,3,3,3,3,3,2,3,2,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2 };
    unsigned char conv_masks[402] = {0,1,2,3,4,5,6,7,8,9, 10,11,12,13,14,15,16,17,18,19, 20,21,22,23,24,25,26,27,28,29, 30,31,32,33,34,35,36,37,38,39, 40,41,42,43,44,45,46,47,48,49, 50,51,52,53,54,55,56,57,58,59, 60,61,62,63,64,65,66,67,68,69, 70,71,72,73,74,75,76,77,78,79, 80,81,82,83,84,85,86,87,88,89, 90,91,92,93,94,95,96,97,98,99, 100,101,102,103,104,105,106,107,108,109, 110,111,112,113,114,115,116,117,118,119, 120,121,122,123,124,125,126,127, 208, 130, 208, 131, 226, 128, 154, 209, 147, 226, 128, 158, 226, 128, 166, 226, 128, 160, 226, 128, 161, 226, 130, 172, 226, 128, 176, 208, 137, 226, 128, 185, 208, 138, 208, 140, 208, 139, 208, 143, 209, 146, 226, 128, 152, 226, 128, 153, 226, 128, 156, 226, 128, 157, 226, 128, 162, 226, 128, 147, 226, 128, 148, 194, 152, 226, 132, 162, 209, 153, 226, 128, 186, 209, 154, 209, 156, 209, 155, 209, 159, 194, 160, 208, 142, 209, 158, 208, 139, 194, 164, 210, 144, 194, 166, 194, 167, 208, 129, 194, 169, 208, 132, 194, 171, 194, 172, 194, 173, 194, 174, 208, 135, 194, 176, 194, 177, 208, 134, 209, 150, 210, 145, 194, 181, 194, 182, 194, 183, 209, 145, 226, 132, 150, 209, 148, 194, 187, 209, 152, 208, 133, 209, 149, 209, 151, 208, 144, 208, 145, 208, 146, 208, 147, 208, 148, 208, 149, 208, 150, 208, 151, 208, 152, 208, 153, 208, 154, 208, 155, 208, 156, 208, 157, 208, 158, 208, 159, 208, 160, 208, 161, 208, 162, 208, 163, 208, 164, 208, 165, 208, 166, 208, 167, 208, 168, 208, 169, 208, 170, 208, 171, 208, 172, 208, 173, 208, 174, 208, 175, 208, 176, 208, 177, 208, 178, 208, 179, 208, 180, 208, 181, 208, 182, 208, 183, 208, 184, 208, 185, 208, 186, 208, 187, 208, 188, 208, 189, 208, 190, 208, 191, 209, 128, 209, 129, 209, 130, 209, 131, 209, 132, 209, 133, 209, 134, 209, 135, 209, 136, 209, 137, 209, 138, 209, 139, 209, 140, 209, 141, 209, 142, 209, 143};

    do
    {
        fseek(stream, offset, SEEK_SET);
        fread(&char1251, sizeof(char1251), 1, stream);
        int idx = idxs[char1251];
        int len = lens[char1251];

        for(int i = idx; i < idx+len; ++i)
        {
            write_[0] = conv_masks[i];
            fwrite(write_, 1 , sizeof(write_), stream_save);
        }
        ++offset;
    } while (offset != sz); // пока не конец файла

    return 0;
}


int main(int argc, char **argv)
{
    printf("%s", "Введите имя файла: ");
    char file_name[FILENAME_MAX] = "cp1251.txt";
    scanf("%s", &file_name);
    printf("%s", "Введите имя файла для записи: ");
    char file_name_save[FILENAME_MAX] = "t.txt";
    scanf("%s", &file_name_save);

    if(file_exists(file_name))
    {
        FILE *file;

        FILE *file_save;

        file = fopen(file_name, "rb+");
        file_save = fopen(file_name_save, "wb+");

        convert_CP1251_to_UTF8(file, file_save);

        fclose(file);
        fclose(file_save);
        printf("%s\n", "Конвертация завершина.");
    }
    else
    {
        printf("%s\n", "Файл не найден.");

    }
    printf("Программа завершена.\n");
    return 0;
}
