#include <stdio.h>
#include <stdlib.h>
#include <sys/stat.h>
#include <stdbool.h>


bool file_exists (char *filename) {
  struct stat   buffer;
  return (stat (filename, &buffer) == 0);
}

int convert_(FILE *stream, FILE *stream_save, int *convertation_mask)
{
    unsigned char char1251;
    fseek(stream, 0L, SEEK_END);
    long sz = ftell(stream);
    long offset = 0;
    unsigned char write_[1] = {0};

    do
    {
        fseek(stream, offset, SEEK_SET);
        fread(&char1251, sizeof(char), 1, stream);
        for(int i = char1251*3; i < char1251*3+3; ++i)
        {
            if(convertation_mask[i] != -1)
            {
                write_[0] = (unsigned char)convertation_mask[i];
                fwrite(write_ , 1 , sizeof(write_), stream_save);
            }
            else
            {
                break;
            }
        }
        ++offset;
    } while (offset != sz); // пока не конец файла

    return 0;
}


int main(int argc, char **argv)
{
    printf("%s", "Введите имя файла: ");
    char file_name[FILENAME_MAX] = "cp1251.txt";
    scanf("%s", &file_name);
    printf("%s", "Введите имя файла для записи: ");
    char file_name_save[FILENAME_MAX] = "t.txt";
    scanf("%s", &file_name_save);

    int CP1251_to_UTF8[256][3] = {
    {0,-1,-1},//000	00	NOP
    {1,-1,-1},//001	01	SOH
    {2,-1,-1},//002	02	STX
    {3,-1,-1},//003	03	ETX
    {4,-1,-1},//004	04	EOT
    {5,-1,-1},//005	05	ENQ
    {6,-1,-1},//006	06	ACK
    {7,-1,-1},//007	07	BEL
    {8,-1,-1},//008	08	BS
    {9,-1,-1},//009	09	TAB
    {10,-1,-1},//010	0A	LF
    {11,-1,-1},//011	0B	VT
    {12,-1,-1},//012	0C	FF
    {13,-1,-1},//013	0D	CR
    {14,-1,-1},//014	0E	SO
    {15,-1,-1},//015	0F	SI
    {16,-1,-1},//016	10	DLE
    {17,-1,-1},//017	11	DC1
    {18,-1,-1},//018	12	DC2
    {19,-1,-1},//019	13	DC3
    {20,-1,-1},//020	14	DC4
    {21,-1,-1},//021	15	NAK
    {22,-1,-1},//022	16	SYN
    {23,-1,-1},//023	17	ETB
    {24,-1,-1},//024	18	CAN
    {25,-1,-1},//025	19	EM
    {26,-1,-1},//026	1A	SUB
    {27,-1,-1},//027	1B	ESC
    {28,-1,-1},//028	1C	FS
    {29,-1,-1},//029	1D	GS
    {30,-1,-1},//030	1E	RS
    {31,-1,-1},//031	1F	US
    {32,-1,-1},//032	20	SP
    {33,-1,-1},//033	21	!
    {34,-1,-1},//034	22	"
    {35,-1,-1},//035	23	#
    {36,-1,-1},//036	24	$
    {37,-1,-1},//037	25	%
    {38,-1,-1},//038	26	&
    {39,-1,-1},//039	27	'
    {40,-1,-1},//040	28	(
    {41,-1,-1},//041	29	)
    {42,-1,-1},//042	2A	*
    {43,-1,-1},//043	2B	+
    {44,-1,-1},//044	2C	,
    {45,-1,-1},//045	2D	-
    {46,-1,-1},//046	2E	.
    {47,-1,-1},//047	2F	/
    {48,-1,-1},//048	30	0
    {49,-1,-1},//049	31	1
    {50,-1,-1},//050	32	2
    {51,-1,-1},//051	33	3
    {52,-1,-1},//052	34	4
    {53,-1,-1},//053	35	5
    {54,-1,-1},//054	36	6
    {55,-1,-1},//055	37	7
    {56,-1,-1},//056	38	8
    {57,-1,-1},//057	39	9
    {58,-1,-1},//058	3A	:
    {59,-1,-1},//059	3B	;
    {60,-1,-1},    //060	3C	<
    {61,-1,-1},    //061	3D	=
    {62,-1,-1},    //062	3E	>
    {63,-1,-1},    //063	3F	?
    {64,-1,-1},    //064	40	@
    {65,-1,-1},   //065	41	A
    {66,-1,-1},    //066	42	B
    {67,-1,-1},    //067	43	C
    {68,-1,-1},    //068	44	D
    {69,-1,-1},    //069	45	E
    {70,-1,-1},    //070	46	F
    {71,-1,-1},    //071	47	G
    {72,-1,-1},    //072	48	H
    {73,-1,-1},    //073	49	I
    {74,-1,-1},    //074	4A	J
    {75,-1,-1},    //075	4B	K
    {76,-1,-1},    //076	4C	L
    {77,-1,-1},    //077	4D	M
    {78,-1,-1},    //078	4E	N
    {79,-1,-1},    //079	4F	O
    {80,-1,-1},    //080	50	P
    {81,-1,-1},    //081	51	Q
    {82,-1,-1},    //082	52	R
    {83,-1,-1},    //083	53	S
    {84,-1,-1},    //084	54	T
    {85,-1,-1},    //085	55	U
    {86,-1,-1},    //086	56	V
    {87,-1,-1},    //087	57	W
    {88,-1,-1},    //088	58	X
    {89,-1,-1},    //089	59	Y
    {90,-1,-1},    //090	5A	Z
    {91,-1,-1},    //091	5B	[
    {92,-1,-1},    //092	5C  \/
    {93,-1,-1},    //093	5D	]
    {94,-1,-1},    //094	5E	^
    {95,-1,-1},    //095	5F	_
    {96,-1,-1},    //096	60	`
    {97,-1,-1},    //097	61	a
    {98,-1,-1},    //098	62	b
    {99,-1,-1},    //099	63	c
    {100,-1,-1},    //100	64	d
    {101,-1,-1},    //101	65	e
    {102,-1,-1},    //102	66	f
    {103,-1,-1},    //103	67	g
    {104,-1,-1},    //104	68	h
    {105,-1,-1},    //105	69	i
    {106,-1,-1},    //106	6A	j
    {107,-1,-1},    //107	6B	k
    {108,-1,-1},    //108	6C	l
    {109,-1,-1},    //109	6D	m
    {110,-1,-1},    //110	6E	n
    {111,-1,-1},    //111	6F	o
    {112,-1,-1},    //112	70	p
    {113,-1,-1},    //113	71	q
    {114,-1,-1},    //114	72	r
    {115,-1,-1},    //115	73	s
    {116,-1,-1},    //116	74	t
    {117,-1,-1},    //117	75	u
    {118,-1,-1},    //118	76	v
    {119,-1,-1},    //119	77	w
    {120,-1,-1},    //120	78	x
    {121,-1,-1},    //121	79	y
    {122,-1,-1},    //122	7A	z
    {123,-1,-1},    //123	7B	{
    {124,-1,-1},    //124	7C	|
    {125,-1,-1},    //125	7D	}
    {126,-1,-1},    //126	7E	~
    {127,-1,-1},    //127	7F	DEL
    {208, 130,-1},    //128	80	Ђ
    {208, 131,-1},    //129	81	Ѓ
    {226, 128, 154},    //130	82	‚
    {209, 147,-1},    //131	83	ѓ
    {226, 128, 158},    //132	84	„
    {226, 128, 166},    //133	85	…
    {226, 128, 160},    //134	86	†
    {226, 128, 161},    //135	87	‡
    {226, 130, 172},    //136	88	€
    {226, 128, 176},    //137	89	‰
    {208, 137,-1},    //138	8A	Љ
    {226, 128, 185},    //139	8B	‹
    {208, 138,-1},    //140	8C	Њ
    {208, 140,-1},    //141	8D	Ќ
    {208, 139,-1},    //142	8E	Ћ
    {208, 143,-1},    //143	8F	Џ
    {209, 146,-1},    //144	90	ђ
    {226, 128, 152},    //145	91	‘
    {226, 128, 153},    //146	92	’
    {226, 128, 156},    //147	93	“
    {226, 128, 157},    //148	94	”
    {226, 128, 162},    //149	95	•
    {226, 128, 147},    //150	96	–
    {226, 128, 148},    //151	97	—
    {194, 152,-1},    //152	98 \n
    {226, 132, 162},    //153	99	™
    {209, 153,-1},    //154	9A	љ
    {226, 128, 186},    //155	9B	›
    {209, 154,-1},    //156	9C	њ
    {209, 156,-1},    //157	9D	ќ
    {209, 155,-1},    //158	9E	ћ
    {209, 159,-1},    //159	9F	џ
    {194, 160,-1},    //160	A0  No-Break Space
    {208, 142,-1},    //161	A1	Ў
    {209, 158,-1},    //162	A2	ў
    {208, 139,-1},    //163	A3	Ћ
    {194, 164,-1},    //164	A4	¤
    {210, 144,-1},    //165	A5	Ґ
    {194, 166,-1},    //166	A6	¦
    {194, 167,-1},    //167	A7	§
    {208, 129,-1},    //168	A8	Ё
    {194, 169,-1},    //169	A9	©
    {208, 132,-1},    //170	AA	Є
    {194, 171,-1},    //171	AB	«
    {194, 172,-1},    //172	AC	¬
    {194, 173,-1},    //173	AD  Soft Hyphen
    {194, 174,-1},    //174	AE	®
    {208, 135,-1},    //175	AF	Ї
    {194, 176,-1},    //176	B0	°
    {194, 177,-1},    //177	B1	±
    {208, 134,-1},    //178	B2	І
    {209, 150,-1},    //179	B3	і
    {210, 145,-1},    //180	B4	ґ
    {194, 181,-1},    //181	B5	µ
    {194, 182,-1},    //182	B6	¶
    {194, 183,-1},    //183	B7	·
    {209, 145,-1},    //184	B8	ё
    {226, 132, 150},    //185	B9	№
    {209, 148,-1},    //186	BA	є
    {194, 187,-1},    //187	BB	»
    {209, 152,-1},    //188	BC	ј
    {208, 133,-1},    //189	BD	Ѕ
    {209, 149,-1},    //190	BE	ѕ
    {209, 151,-1},    //191	BF	ї
    {208, 144,-1},    //192	C0	А
    {208, 145,-1},    //193	C1	Б
    {208, 146,-1},    //194	C2	В
    {208, 147,-1},    //195	C3	Г
    {208, 148,-1},    //196	C4	Д
    {208, 149,-1},    //197	C5	Е
    {208, 150,-1},    //198	C6	Ж
    {208, 151,-1},    //199	C7	З
    {208, 152,-1},    //200	C8	И
    {208, 153,-1},    //201	C9	Й
    {208, 154,-1},    //202	CA	К
    {208, 155,-1},    //203	CB	Л
    {208, 156,-1},    //204	CC	М
    {208, 157,-1},    //205	CD	Н
    {208, 158,-1},    //206	CE	О
    {208, 159,-1},    //207	CF	П
    {208, 160,-1},    //208	D0	Р
    {208, 161,-1},    //209	D1	С
    {208, 162,-1},    //210	D2	Т
    {208, 163,-1},    //211	D3	У
    {208, 164,-1},    //212	D4	Ф
    {208, 165,-1},    //213	D5	Х
    {208, 166,-1},    //214	D6	Ц
    {208, 167,-1},    //215	D7	Ч
    {208, 168,-1},    //216	D8	Ш
    {208, 169,-1},    //217	D9	Щ
    {208, 170,-1},    //218	DA	Ъ
    {208, 171,-1},    //219	DB	Ы
    {208, 172,-1},    //220	DC	Ь
    {208, 173,-1},    //221	DD	Э
    {208, 174,-1},    //222	DE	Ю
    {208, 175,-1},    //223	DF	Я
    {208, 176,-1},    //224	E0	а
    {208, 177,-1},    //225	E1	б
    {208, 178,-1},    //226	E2	в
    {208, 179,-1},    //227	E3	г
    {208, 180,-1},    //228	E4	д
    {208, 181,-1},    //229	E5	е
    {208, 182,-1},    //230	E6	ж
    {208, 183,-1},    //231	E7	з
    {208, 184,-1},    //232	E8	и
    {208, 185,-1},    //233	E9	й
    {208, 186,-1},    //234	EA	к
    {208, 187,-1},    //235	EB	л
    {208, 188,-1},    //236	EC	м
    {208, 189,-1},    //237	ED	н
    {208, 190,-1},    //238	EE	о
    {208, 191,-1},    //239	EF	п
    {209, 128,-1},    //240	F0	р
    {209, 129,-1},    //241	F1	с
    {209, 130,-1},    //242	F2	т
    {209, 131,-1},    //243	F3	у
    {209, 132,-1},    //244	F4	ф
    {209, 133,-1},    //245	F5	х
    {209, 134,-1},    //246	F6	ц
    {209, 135,-1},    //247	F7	ч
    {209, 136,-1},    //248	F8	ш
    {209, 137,-1},    //249	F9	щ
    {209, 138,-1},    //250	FA	ъ
    {209, 139,-1},    //251	FB	ы
    {209, 140,-1},    //252	FC	ь
    {209, 141,-1},    //253	FD	э
    {209, 142,-1},    //254	FE	ю
    {209, 143,-1}    //255	FF	я
    };


    if(file_exists(file_name))
    {
        FILE *file;

        FILE *file_save;

        file = fopen(file_name, "rb+");
        file_save = fopen(file_name_save, "wb+");

        convert_(file, file_save, CP1251_to_UTF8);

        fclose(file);
        fclose(file_save);
        printf("%s\n", "Конвертация завершина.");
    }
    else
    {
        printf("%s\n", "Файл не найден.");

    }
    printf("Программа завершена.\n");
    return 0;
}
